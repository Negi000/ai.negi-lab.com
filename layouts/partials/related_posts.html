{{/* é–¢é€£è¨˜äº‹ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ - åŒã˜ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ»ã‚¿ã‚°ã®è¨˜äº‹ã‚’è¡¨ç¤º */}}
{{- $currentPage := . -}}
{{- $related := slice -}}

{{/* 1. åŒã˜ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è¨˜äº‹ã‚’å–å¾— */}}
{{- $categories := .GetTerms "categories" -}}
{{- range $categories -}}
  {{- $categoryPages := .Pages -}}
  {{- range $categoryPages -}}
    {{- if ne .Permalink $currentPage.Permalink -}}
      {{- $related = $related | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 2. åŒã˜ã‚¿ã‚°ã®è¨˜äº‹ã‚‚è¿½åŠ  */}}
{{- $tags := .GetTerms "tags" -}}
{{- range $tags -}}
  {{- $tagPages := .Pages -}}
  {{- range $tagPages -}}
    {{- if and (ne .Permalink $currentPage.Permalink) (not (in $related .)) -}}
      {{- $related = $related | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 3. é‡è¤‡ã‚’é™¤å»ã—ã¦æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆã€æœ€å¤§6ä»¶ */}}
{{- $related = $related | uniq -}}
{{- $related = sort $related ".Date" "desc" -}}
{{- $related = first 6 $related -}}

{{/* 4. é–¢é€£è¨˜äº‹ãŒãªã‘ã‚Œã°æœ€æ–°è¨˜äº‹ã‚’è¡¨ç¤º */}}
{{- if eq (len $related) 0 -}}
  {{- $related = where site.RegularPages "Section" "posts" -}}
  {{- $related = where $related ".Permalink" "!=" $currentPage.Permalink -}}
  {{- $related = first 6 $related -}}
{{- end -}}

{{- if gt (len $related) 0 -}}
<div class="related-posts">
  <h2>ğŸ“š é–¢é€£è¨˜äº‹</h2>
  <div class="related-posts-grid">
    {{- range $related -}}
    <article class="related-post-card">
      <a href="{{ .Permalink }}" class="related-post-link">
        {{- $cover := .Params.cover -}}
        {{- if $cover.image -}}
        <div class="related-post-image">
          <img src="{{ $cover.image }}" alt="{{ .Title }}" loading="lazy">
        </div>
        {{- end -}}
        <div class="related-post-content">
          {{- with .GetTerms "categories" -}}
          <span class="related-post-category">{{ (index . 0).LinkTitle }}</span>
          {{- end -}}
          <h3 class="related-post-title">{{ .Title | truncate 50 }}</h3>
          <time class="related-post-date">{{ .Date.Format "2006.01.02" }}</time>
        </div>
      </a>
    </article>
    {{- end -}}
  </div>
</div>
{{- end -}}
